---
import RepoCard from '../components/RepoCard.astro';
import BlogPostCard from '../components/BlogPostCard.astro';
import type { BlogPost } from '../components/BlogPostCard.astro';
import SoftwareGbbCard from '../components/SoftwareGbbCard.astro';
import type { SoftwareGbb } from '../components/SoftwareGbbCard.astro';
import Layout from '../layouts/Layout.astro';
import { 
  ASSET_CATEGORIES, 
  ASSET_TYPES, 
  categorizeRepositories, 
  groupByCategory, 
  groupByAssetType,
  type AssetCategory, 
  type AssetType,
  type Repository,
  formatDate
} from '../utils/categorize';

// Import repository data
// This file is updated via GitHub Actions workflow
import repositoriesData from '../data/repositories.json';
import softwareGbbsData from '../data/software-gbbs.json';
import blogPostsData from '../data/blog-posts.json';

// Import catalog metadata
let catalogMetadataData: Record<string, any> = {};
try {
  catalogMetadataData = await import('../data/catalog-metadata.json').then(m => m.default);
} catch (err) {
  console.warn('Catalog metadata not found, continuing without it');
}

// Merge catalog metadata with repository data
const repositoriesWithCatalog = (repositoriesData as Repository[]).map(repo => ({
  ...repo,
  catalogMetadata: catalogMetadataData[repo.name]
}));

// Filter out the .github repository (special GitHub org config repo)
const repositories = repositoriesWithCatalog.filter(repo => repo.name !== '.github');
const categorizedRepos = categorizeRepositories(repositories);

// Filter out archived repos by default and sort by updated date
const activeRepos = categorizedRepos
  .filter(repo => !repo.isArchived)
  .sort((a, b) => new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime());

const archivedRepos = categorizedRepos.filter(repo => repo.isArchived);

// Group for stats
const groupedByCategory = groupByCategory(categorizedRepos);
const groupedByType = groupByAssetType(categorizedRepos);

// Software GBBs
const softwareGbbs = (softwareGbbsData.members as SoftwareGbb[]).filter(m => m.totalContributions > 0);

// Blog posts (already filtered in workflow by desired author(s))
const blogPosts = blogPostsData as BlogPost[];

// Calculate stats - include blog posts in the "blog" asset type
const forkCount = activeRepos.filter(r => r.isFork).length;
const totalItems = activeRepos.length + blogPosts.length;
const stats = {
  total: repositories.length,
  active: activeRepos.length,
  archived: archivedRepos.length,
  forks: forkCount,
  blogPosts: blogPosts.length,
  totalItems: totalItems,
  byCategory: Object.entries(groupedByCategory)
    .filter(([_, repos]) => repos.length > 0)
    .map(([category, repos]) => ({
      category: ASSET_CATEGORIES[category as AssetCategory],
      count: repos.length,
      activeCount: repos.filter(r => !r.isArchived).length,
    }))
    .sort((a, b) => b.count - a.count),
  byType: (() => {
    const types = Object.entries(groupedByType)
      .filter(([_, repos]) => repos.length > 0)
      .map(([assetType, repos]) => ({
        assetType: ASSET_TYPES[assetType as AssetType],
        count: repos.length,
        activeCount: repos.filter(r => !r.isArchived).length,
      }));
    
    // Add blog posts to the "blog" type or create it if it doesn't exist
    const blogTypeIndex = types.findIndex(t => t.assetType.name === 'blog');
    if (blogTypeIndex >= 0) {
      types[blogTypeIndex].count += blogPosts.length;
      types[blogTypeIndex].activeCount += blogPosts.length;
    } else if (blogPosts.length > 0) {
      types.push({
        assetType: ASSET_TYPES['blog'],
        count: blogPosts.length,
        activeCount: blogPosts.length,
      });
    }
    
    return types.sort((a, b) => b.count - a.count);
  })(),
};
---

<Layout title="IP Atlas - DevExpGbb">
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    {/* Hero Section - Shrinks on scroll */}
    <header id="hero-section" class="text-center mb-12 transition-all duration-500 ease-out">
      {/* Logo */}
      <div class="flex justify-center">
        <img 
          id="hero-logo"
          src="/IP-Atlas-logo.png" 
          alt="IP Atlas Logo" 
          class="w-96 h-96 object-contain transition-all duration-500 ease-out" 
        />
      </div>
      <p id="hero-text" class="text-lg text-gray-600 dark:text-gray-300 max-w-2xl mx-auto mb-6 -mt-8 transition-all duration-500 ease-out">
        Repository catalog and content generated by the <strong class="text-gray-800 dark:text-white">DevExpGbb</strong> team.
        Explore demos, workshops, tools, and more.
      </p>

      {/* Stats */}
      <div id="hero-stats" class="flex flex-wrap justify-center gap-4 text-sm transition-all duration-500 ease-out">
        <div class="bg-white dark:bg-gray-800 px-4 py-2 rounded-full shadow-sm border border-gray-100 dark:border-gray-700">
          <span class="font-bold text-gray-900 dark:text-white">{stats.total}</span>
          <span class="text-gray-500 dark:text-gray-400 ml-1">repositories</span>
        </div>
        <div class="bg-white dark:bg-gray-800 px-4 py-2 rounded-full shadow-sm border border-gray-100 dark:border-gray-700">
          <span class="font-bold text-green-600 dark:text-green-400">{stats.active}</span>
          <span class="text-gray-500 dark:text-gray-400 ml-1">active</span>
        </div>
        {stats.archived > 0 && (
          <div class="bg-white dark:bg-gray-800 px-4 py-2 rounded-full shadow-sm border border-gray-100 dark:border-gray-700">
            <span class="font-bold text-gray-400">{stats.archived}</span>
            <span class="text-gray-500 dark:text-gray-400 ml-1">archived</span>
          </div>
        )}
      </div>
    </header>

    {/* Main Content with Sidebar */}
    <div class="flex flex-col lg:flex-row gap-6">
      {/* Filters Sidebar */}
      <aside class="lg:w-56 flex-shrink-0">
        <div class="lg:sticky lg:top-20 bg-white dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700 p-3 shadow-sm space-y-3">
          <h2 class="text-sm font-bold text-gray-900 dark:text-white pb-2 border-b border-gray-100 dark:border-gray-700">Filters</h2>
          
          {/* Asset Category Filter */}
          <div>
            <h3 class="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1.5 flex items-center gap-1">
              üóÇÔ∏è Asset Category
            </h3>
            <div class="flex flex-col gap-0.5">
              {stats.byCategory.map(({ category, activeCount }) => (
                activeCount > 0 && (
                  <label class="flex items-center gap-2 px-2 py-1 rounded hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors">
                    <input
                      type="checkbox"
                      class="category-checkbox w-3.5 h-3.5 rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500"
                      data-category={category.name}
                    />
                    <span class="text-xs text-gray-700 dark:text-gray-300 flex items-center gap-1.5">
                      <span>{category.emoji}</span>
                      <span>{category.label}</span>
                    </span>
                    <span class="ml-auto text-[10px] text-gray-400">{activeCount}</span>
                  </label>
                )
              ))}
            </div>
          </div>
          
          {/* Asset Type Filter */}
          <div class="pt-2 border-t border-gray-100 dark:border-gray-700">
            <h3 class="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1.5 flex items-center gap-1">
              üìã Asset Type
            </h3>
            <div class="flex flex-col gap-0.5">
              {stats.byType.map(({ assetType, activeCount }) => (
                activeCount > 0 && (
                  <label class="flex items-center gap-2 px-2 py-1 rounded hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors">
                    <input
                      type="checkbox"
                      class="type-checkbox w-3.5 h-3.5 rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500"
                      data-type={assetType.name}
                    />
                    <span class="text-xs text-gray-700 dark:text-gray-300 flex items-center gap-1.5">
                      <span>{assetType.emoji}</span>
                      <span>{assetType.label}</span>
                    </span>
                    <span class="ml-auto text-[10px] text-gray-400">{activeCount}</span>
                  </label>
                )
              ))}
            </div>
          </div>

          {/* Fork Filter */}
          {stats.forks > 0 && (
            <div class="pt-2 border-t border-gray-100 dark:border-gray-700">
              <h3 class="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1.5 flex items-center gap-1">
                üç¥ Forks
              </h3>
              <label class="flex items-center gap-2 px-2 py-1 rounded hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors">
                <input
                  type="checkbox"
                  id="fork-filter"
                  class="w-3.5 h-3.5 rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500"
                />
                <span class="text-xs text-gray-700 dark:text-gray-300">Show only forks</span>
                <span class="ml-auto text-[10px] text-gray-400">{stats.forks}</span>
              </label>
            </div>
          )}
          
          <div class="pt-2 border-t border-gray-100 dark:border-gray-700 flex justify-between items-center">
            <p id="filter-status" class="text-[10px] text-gray-500 dark:text-gray-400">
              Showing {stats.totalItems} items
            </p>
            <button
              id="clear-filters"
              class="text-[10px] text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 font-medium"
            >
              Clear filters
            </button>
          </div>
        </div>
      </aside>

      {/* Main Content */}
      <div class="flex-1 min-w-0">
        {/* Assets Grid (Repositories + Blog Posts) */}
        <section class="mb-10">
          <h2 class="text-lg font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
            </svg>
            Assets
            <span class="text-xs font-normal text-gray-500 dark:text-gray-400">({stats.totalItems} items)</span>
          </h2>
          
          {stats.totalItems === 0 ? (
            <p class="text-gray-500 text-center py-8">No assets available.</p>
          ) : (
            <div id="repos-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4">
              {/* Blog Posts */}
              {blogPosts.map(post => (
                <div class="repo-item" data-fork="false" data-category="other" data-type="blog">
                  <BlogPostCard post={post} />
                </div>
              ))}
              {/* Repositories */}
              {activeRepos.map(repo => (
                <div class="repo-item" data-fork={repo.isFork ? "true" : "false"} data-category={repo.category} data-type={repo.assetType}>
                  <RepoCard repo={repo} />
                </div>
              ))}
            </div>
          )}
          
          {/* No results message */}
          <p id="no-results" class="text-gray-500 text-center py-8 hidden">No repositories match the current filters.</p>
        </section>

        {/* Software GBBs Section */}
        {softwareGbbs.length > 0 && (
          <section class="mb-10 border-t border-gray-200 pt-6">
            <h2 class="text-lg font-bold text-gray-800 mb-1 flex items-center gap-2">
              <span class="text-lg">ü•ã</span>
              Software GBBs
              <span class="text-xs font-normal text-gray-500 ml-2">({softwareGbbs.length} active)</span>
            </h2>
            <p class="text-xs text-gray-500 mb-4">Software Global Black Belts contributing to this organization.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4">
              {softwareGbbs.map((member, index) => (
                <SoftwareGbbCard member={member} rank={index + 1} />
              ))}
            </div>
          </section>
        )}

        {/* Archived Repos (collapsed) */}
        {archivedRepos.length > 0 && (
          <section class="border-t border-gray-200 pt-6">
            <details class="group">
              <summary class="cursor-pointer text-sm font-semibold text-gray-500 hover:text-gray-700 flex items-center gap-2 mb-4">
                <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
                Archived Repositories ({archivedRepos.length})
              </summary>
              <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4">
                {archivedRepos.map(repo => (
                  <RepoCard repo={repo} />
                ))}
              </div>
            </details>
          </section>
        )}
      </div>
    </div>

    {/* Footer */}
    <footer class="mt-10 pt-6 border-t border-gray-200 text-center text-xs text-gray-500">
      <p>
        Data automatically updated from
        <a href="https://github.com/DevExpGbb" class="text-blue-500 hover:underline ml-1" target="_blank" rel="noopener">
          github.com/DevExpGbb
        </a>
      </p>
      <p class="mt-2 text-xs">
        Last updated: {new Date().toLocaleDateString('en-US')}
      </p>
      <p class="mt-4 text-xs flex items-center justify-center gap-1">
        Made with <span class="text-red-500">‚ù§Ô∏è</span> and 
        <a href="https://github.com/features/copilot" class="inline-flex items-center gap-1 text-gray-600 hover:text-blue-500" target="_blank" rel="noopener">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0012 2z"/>
          </svg>
          GitHub Copilot
        </a>
      </p>
    </footer>
  </main>

  <script>
    // Filter state
    let selectedCategories: Set<string> = new Set();
    let selectedTypes: Set<string> = new Set();
    let showOnlyForks = false;
    
    const categoryCheckboxes = document.querySelectorAll<HTMLInputElement>('.category-checkbox');
    const typeCheckboxes = document.querySelectorAll<HTMLInputElement>('.type-checkbox');
    const forkFilter = document.getElementById('fork-filter') as HTMLInputElement | null;
    const clearFiltersBtn = document.getElementById('clear-filters');
    const repoItems = document.querySelectorAll('.repo-item');
    const noResults = document.getElementById('no-results');
    const filterStatus = document.getElementById('filter-status');
    
    // Apply all filters
    function applyFilters() {
      let visibleCount = 0;
      
      repoItems.forEach(item => {
        const itemCategory = item.getAttribute('data-category');
        const itemType = item.getAttribute('data-type');
        const isFork = item.getAttribute('data-fork') === 'true';
        
        // If no category selected, show all categories
        const matchesCategory = selectedCategories.size === 0 || 
          (itemCategory && selectedCategories.has(itemCategory));
        
        // If no type selected, show all types
        const matchesType = selectedTypes.size === 0 || 
          (itemType && selectedTypes.has(itemType));
        
        const matchesFork = !showOnlyForks || isFork;
        
        if (matchesCategory && matchesType && matchesFork) {
          (item as HTMLElement).style.display = '';
          visibleCount++;
        } else {
          (item as HTMLElement).style.display = 'none';
        }
      });
      
      // Show/hide no results message
      if (noResults) {
        noResults.classList.toggle('hidden', visibleCount > 0);
      }
      
      // Update filter status
      if (filterStatus) {
        filterStatus.textContent = `Showing ${visibleCount} item${visibleCount !== 1 ? 's' : ''}`;
      }
    }
    
    // Category checkbox handlers
    categoryCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const category = checkbox.getAttribute('data-category');
        if (category) {
          if (checkbox.checked) {
            selectedCategories.add(category);
          } else {
            selectedCategories.delete(category);
          }
        }
        applyFilters();
      });
    });
    
    // Type checkbox handlers
    typeCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const type = checkbox.getAttribute('data-type');
        if (type) {
          if (checkbox.checked) {
            selectedTypes.add(type);
          } else {
            selectedTypes.delete(type);
          }
        }
        applyFilters();
      });
    });
    
    // Fork filter handler
    if (forkFilter) {
      forkFilter.addEventListener('change', () => {
        showOnlyForks = forkFilter.checked;
        applyFilters();
      });
    }
    
    // Clear filters
    if (clearFiltersBtn) {
      clearFiltersBtn.addEventListener('click', () => {
        selectedCategories.clear();
        selectedTypes.clear();
        showOnlyForks = false;
        
        categoryCheckboxes.forEach(cb => cb.checked = false);
        typeCheckboxes.forEach(cb => cb.checked = false);
        if (forkFilter) forkFilter.checked = false;
        
        applyFilters();
      });
    }
    
    // Hero shrink on scroll
    const heroSection = document.getElementById('hero-section');
    const heroLogo = document.getElementById('hero-logo');
    const heroText = document.getElementById('hero-text');
    const heroStats = document.getElementById('hero-stats');
    
    let isHeroShrunk = false;
    const scrollThreshold = 100;
    
    function handleScroll() {
      const scrollY = window.scrollY;
      
      if (scrollY > scrollThreshold && !isHeroShrunk) {
        isHeroShrunk = true;
        // Shrink logo
        heroLogo?.classList.remove('w-96', 'h-96');
        heroLogo?.classList.add('w-24', 'h-24');
        // Shrink text
        heroText?.classList.add('text-sm', 'mb-3', 'opacity-80');
        heroText?.classList.remove('text-lg', 'mb-6');
        // Shrink section margins
        heroSection?.classList.remove('mb-12');
        heroSection?.classList.add('mb-6');
        // Shrink stats
        heroStats?.classList.add('text-xs', 'gap-2');
        heroStats?.classList.remove('text-sm', 'gap-4');
      } else if (scrollY <= scrollThreshold && isHeroShrunk) {
        isHeroShrunk = false;
        // Restore logo
        heroLogo?.classList.add('w-96', 'h-96');
        heroLogo?.classList.remove('w-24', 'h-24');
        // Restore text
        heroText?.classList.remove('text-sm', 'mb-3', 'opacity-80');
        heroText?.classList.add('text-lg', 'mb-6');
        // Restore section margins
        heroSection?.classList.add('mb-12');
        heroSection?.classList.remove('mb-6');
        // Restore stats
        heroStats?.classList.remove('text-xs', 'gap-2');
        heroStats?.classList.add('text-sm', 'gap-4');
      }
    }
    
    window.addEventListener('scroll', handleScroll, { passive: true });
  </script>
</Layout>
