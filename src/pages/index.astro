---
import RepoCard from '../components/RepoCard.astro';
import Layout from '../layouts/Layout.astro';
import { CATEGORIES, categorizeRepositories, groupByCategory, type RepoCategory, type Repository } from '../utils/categorize';

// Import repository data
// This file is updated via GitHub Actions workflow
import repositoriesData from '../data/repositories.json';

const repositories = repositoriesData as Repository[];
const categorizedRepos = categorizeRepositories(repositories);

// Filter out archived repos by default and sort by updated date
const activeRepos = categorizedRepos
  .filter(repo => !repo.isArchived)
  .sort((a, b) => new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime());

const archivedRepos = categorizedRepos.filter(repo => repo.isArchived);

// Group for stats
const grouped = groupByCategory(categorizedRepos);

// Calculate stats
const forkCount = activeRepos.filter(r => r.isFork).length;
const stats = {
  total: repositories.length,
  active: activeRepos.length,
  archived: archivedRepos.length,
  forks: forkCount,
  byCategory: Object.entries(grouped)
    .filter(([_, repos]) => repos.length > 0)
    .map(([category, repos]) => ({
      category: CATEGORIES[category as RepoCategory],
      count: repos.length,
      activeCount: repos.filter(r => !r.isArchived).length,
    }))
    .sort((a, b) => b.count - a.count),
};
---

<Layout title="IP Atlas - DevExpGbb">
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    {/* Hero Section */}
    <header class="text-center mb-12">
      {/* Logo */}
      <div class="flex justify-center">
        <img src="/IP-Atlas-logo.png" alt="IP Atlas Logo" class="w-96 h-96 object-contain" />
      </div>
      <p class="text-lg text-gray-600 max-w-2xl mx-auto mb-6 -mt-8">
        Repository catalog and content generated by the <strong class="text-gray-800">DevExpGbb</strong> team.
        Explore demos, workshops, tools, and more.
      </p>

      {/* Companion Site Link */}
      <div class="mb-6">
        <a
          href="https://laughing-adventure-wr24zge.pages.github.io/"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 font-medium hover:underline"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
          </svg>
          Internal IP Atlas Companion Site
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
          </svg>
        </a>
      </div>

      {/* Stats */}
      <div class="flex flex-wrap justify-center gap-4 text-sm">
        <div class="bg-white px-4 py-2 rounded-full shadow-sm border border-gray-100">
          <span class="font-bold text-gray-900">{stats.total}</span>
          <span class="text-gray-500 ml-1">repositories</span>
        </div>
        <div class="bg-white px-4 py-2 rounded-full shadow-sm border border-gray-100">
          <span class="font-bold text-green-600">{stats.active}</span>
          <span class="text-gray-500 ml-1">active</span>
        </div>
        {stats.archived > 0 && (
          <div class="bg-white px-4 py-2 rounded-full shadow-sm border border-gray-100">
            <span class="font-bold text-gray-400">{stats.archived}</span>
            <span class="text-gray-500 ml-1">archived</span>
          </div>
        )}
      </div>
    </header>

    {/* Filters Section */}
    <section class="mb-10">
      {/* Category Filters */}
      <div class="flex flex-wrap justify-center gap-2 mb-4">
        <button
          class="category-filter flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-100 text-gray-700 border-2 border-transparent hover:border-gray-300 transition-all cursor-pointer font-semibold"
          data-category="all"
          data-active="true"
        >
          <span>All</span>
          <span class="text-xs opacity-75">({stats.active})</span>
        </button>
        {stats.byCategory.map(({ category, activeCount }) => (
          activeCount > 0 && (
            <button
              class={`category-filter flex items-center gap-2 px-3 py-1.5 rounded-full border-2 border-transparent hover:border-current transition-all cursor-pointer ${category.bgColor} ${category.color}`}
              data-category={category.name}
              data-active="false"
              data-bg={category.bgColor}
              data-text={category.color}
            >
              <span class="font-semibold">{category.label}</span>
              <span class="text-xs opacity-75">({activeCount})</span>
            </button>
          )
        ))}
      </div>
      
      {/* Fork Filter */}
      {stats.forks > 0 && (
        <div class="flex justify-center">
          <button
            id="fork-filter"
            class="flex items-center gap-2 px-4 py-2 rounded-full border-2 border-violet-200 text-violet-600 hover:bg-violet-50 transition-colors font-medium text-sm"
            data-active="false"
          >
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M5 3.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm0 2.122a2.25 2.25 0 10-1.5 0v.878A2.25 2.25 0 005.75 8.5h1.5v2.128a2.251 2.251 0 101.5 0V8.5h1.5a2.25 2.25 0 002.25-2.25v-.878a2.25 2.25 0 10-1.5 0v.878a.75.75 0 01-.75.75h-4.5A.75.75 0 015 6.25v-.878zm3.75 7.378a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm3-8.75a.75.75 0 100-1.5.75.75 0 000 1.5z"/>
            </svg>
            <span>Show only forks</span>
            <span class="text-xs opacity-75">({stats.forks})</span>
          </button>
        </div>
      )}
    </section>

    {/* Repository Grid */}
    <section class="mb-16">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
        <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
        </svg>
        Active Repositories
      </h2>
      
      {activeRepos.length === 0 ? (
        <p class="text-gray-500 text-center py-12">No active repositories.</p>
      ) : (
        <div id="repos-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {activeRepos.map(repo => (
            <div class="repo-item" data-fork={repo.isFork ? "true" : "false"} data-category={repo.category}>
              <RepoCard repo={repo} />
            </div>
          ))}
        </div>
      )}
      
      {/* No results message */}
      <p id="no-results" class="text-gray-500 text-center py-12 hidden">No repositories match the current filters.</p>
    </section>

    {/* Archived Repos (collapsed) */}
    {archivedRepos.length > 0 && (
      <section class="border-t border-gray-200 pt-10">
        <details class="group">
          <summary class="cursor-pointer text-lg font-semibold text-gray-500 hover:text-gray-700 flex items-center gap-2 mb-6">
            <svg class="w-5 h-5 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
            Archived Repositories ({archivedRepos.length})
          </summary>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {archivedRepos.map(repo => (
              <RepoCard repo={repo} />
            ))}
          </div>
        </details>
      </section>
    )}

    {/* Footer */}
    <footer class="mt-16 pt-8 border-t border-gray-200 text-center text-sm text-gray-500">
      <p>
        Data automatically updated from
        <a href="https://github.com/DevExpGbb" class="text-blue-500 hover:underline ml-1" target="_blank" rel="noopener">
          github.com/DevExpGbb
        </a>
      </p>
      <p class="mt-2 text-xs">
        {/* Command for GitHub Actions: gh repo list DevExpGbb --json name,description,url,owner,isArchived,repositoryTopics,languages,primaryLanguage,createdAt,updatedAt,stargazerCount --limit 100 */}
        Last updated: {new Date().toLocaleDateString('en-US')}
      </p>
    </footer>
  </main>

  <script>
    // Filter state
    let activeCategory = 'all';
    let showOnlyForks = false;
    
    const forkFilter = document.getElementById('fork-filter');
    const categoryFilters = document.querySelectorAll('.category-filter');
    const repoItems = document.querySelectorAll('.repo-item');
    const noResults = document.getElementById('no-results');
    
    // Apply all filters
    function applyFilters() {
      let visibleCount = 0;
      
      repoItems.forEach(item => {
        const itemCategory = item.getAttribute('data-category');
        const isFork = item.getAttribute('data-fork') === 'true';
        
        const matchesCategory = activeCategory === 'all' || itemCategory === activeCategory;
        const matchesFork = !showOnlyForks || isFork;
        
        if (matchesCategory && matchesFork) {
          (item as HTMLElement).style.display = '';
          visibleCount++;
        } else {
          (item as HTMLElement).style.display = 'none';
        }
      });
      
      // Show/hide no results message
      if (noResults) {
        noResults.classList.toggle('hidden', visibleCount > 0);
      }
    }
    
    // Category filter click handlers
    categoryFilters.forEach(btn => {
      btn.addEventListener('click', () => {
        const category = btn.getAttribute('data-category')!;
        activeCategory = category;
        
        // Update button styles
        categoryFilters.forEach(b => {
          const isActive = b.getAttribute('data-category') === category;
          b.setAttribute('data-active', String(isActive));
          
          if (isActive) {
            b.classList.add('ring-2', 'ring-offset-2', 'ring-gray-400');
          } else {
            b.classList.remove('ring-2', 'ring-offset-2', 'ring-gray-400');
          }
        });
        
        applyFilters();
      });
    });
    
    // Fork filter click handler
    if (forkFilter) {
      forkFilter.addEventListener('click', () => {
        showOnlyForks = !showOnlyForks;
        forkFilter.setAttribute('data-active', String(showOnlyForks));
        
        // Update button style
        if (showOnlyForks) {
          forkFilter.classList.remove('border-violet-200', 'text-violet-600', 'hover:bg-violet-50');
          forkFilter.classList.add('bg-violet-500', 'text-white', 'border-violet-500');
          forkFilter.querySelector('span')!.textContent = 'Showing forks only';
        } else {
          forkFilter.classList.add('border-violet-200', 'text-violet-600', 'hover:bg-violet-50');
          forkFilter.classList.remove('bg-violet-500', 'text-white', 'border-violet-500');
          forkFilter.querySelector('span')!.textContent = 'Show only forks';
        }
        
        applyFilters();
      });
    }
    
    // Initialize: mark "All" as active
    const allBtn = document.querySelector('.category-filter[data-category="all"]');
    if (allBtn) {
      allBtn.classList.add('ring-2', 'ring-offset-2', 'ring-gray-400');
    }
  </script>
</Layout>
