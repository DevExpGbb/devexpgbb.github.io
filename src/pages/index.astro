---
import RepoCard from '../components/RepoCard.astro';
import SoftwareGbbCard from '../components/SoftwareGbbCard.astro';
import type { SoftwareGbb } from '../components/SoftwareGbbCard.astro';
import Layout from '../layouts/Layout.astro';
import { CATEGORIES, categorizeRepositories, groupByCategory, type RepoCategory, type Repository } from '../utils/categorize';

// Import repository data
// This file is updated via GitHub Actions workflow
import repositoriesData from '../data/repositories.json';
import softwareGbbsData from '../data/software-gbbs.json';

const repositories = repositoriesData as Repository[];
const categorizedRepos = categorizeRepositories(repositories);

// Filter out archived repos by default and sort by updated date
const activeRepos = categorizedRepos
  .filter(repo => !repo.isArchived)
  .sort((a, b) => new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime());

const archivedRepos = categorizedRepos.filter(repo => repo.isArchived);

// Group for stats
const grouped = groupByCategory(categorizedRepos);

// Software GBBs
const softwareGbbs = (softwareGbbsData.members as SoftwareGbb[]).filter(m => m.totalContributions > 0);

// Calculate stats
const forkCount = activeRepos.filter(r => r.isFork).length;
const stats = {
  total: repositories.length,
  active: activeRepos.length,
  archived: archivedRepos.length,
  forks: forkCount,
  byCategory: Object.entries(grouped)
    .filter(([_, repos]) => repos.length > 0)
    .map(([category, repos]) => ({
      category: CATEGORIES[category as RepoCategory],
      count: repos.length,
      activeCount: repos.filter(r => !r.isArchived).length,
    }))
    .sort((a, b) => b.count - a.count),
};
---

<Layout title="IP Atlas - DevExpGbb">
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    {/* Hero Section */}
    <header class="text-center mb-12">
      {/* Logo */}
      <div class="flex justify-center">
        <img src="/IP-Atlas-logo.png" alt="IP Atlas Logo" class="w-96 h-96 object-contain" />
      </div>
      <p class="text-lg text-gray-600 max-w-2xl mx-auto mb-6 -mt-8">
        Repository catalog and content generated by the <strong class="text-gray-800">DevExpGbb</strong> team.
        Explore demos, workshops, tools, and more.
      </p>

      {/* Stats */}
      <div class="flex flex-wrap justify-center gap-4 text-sm">
        <div class="bg-white px-4 py-2 rounded-full shadow-sm border border-gray-100">
          <span class="font-bold text-gray-900">{stats.total}</span>
          <span class="text-gray-500 ml-1">repositories</span>
        </div>
        <div class="bg-white px-4 py-2 rounded-full shadow-sm border border-gray-100">
          <span class="font-bold text-green-600">{stats.active}</span>
          <span class="text-gray-500 ml-1">active</span>
        </div>
        {stats.archived > 0 && (
          <div class="bg-white px-4 py-2 rounded-full shadow-sm border border-gray-100">
            <span class="font-bold text-gray-400">{stats.archived}</span>
            <span class="text-gray-500 ml-1">archived</span>
          </div>
        )}
      </div>
    </header>

    {/* Main Content with Sidebar */}
    <div class="flex flex-col lg:flex-row gap-8">
      {/* Filters Sidebar */}
      <aside class="lg:w-64 flex-shrink-0">
        <div class="lg:sticky lg:top-24 bg-white rounded-2xl border border-gray-100 p-5 shadow-sm space-y-6">
          {/* Category Filter */}
          <div>
            <h2 class="text-sm font-semibold text-gray-900 mb-4 flex items-center gap-2">
              <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
              </svg>
              Filter by Category
            </h2>
            <div class="flex flex-col gap-2">
              <button
                class="category-filter w-full px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 border text-left flex items-center justify-between bg-blue-600 text-white border-blue-600 shadow-md"
                data-category="all"
                data-active="true"
              >
                <span>All</span>
                <span class="px-2 py-0.5 text-xs rounded-full bg-white/20">
                  {stats.active}
                </span>
              </button>
              {stats.byCategory.map(({ category, activeCount }) => (
                activeCount > 0 && (
                  <button
                    class={`category-filter w-full px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 border text-left flex items-center justify-between bg-white text-gray-700 border-gray-200 hover:border-blue-300 hover:bg-blue-50`}
                    data-category={category.name}
                    data-active="false"
                    data-bg={category.bgColor}
                    data-text={category.color}
                  >
                    <span>{category.label}</span>
                    <span class="px-2 py-0.5 text-xs rounded-full bg-gray-100">
                      {activeCount}
                    </span>
                  </button>
                )
              ))}
            </div>
          </div>
          
          {/* Fork Filter */}
          {stats.forks > 0 && (
            <div class="pt-4 border-t border-gray-100">
              <h2 class="text-sm font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <svg class="w-4 h-4 text-gray-500" fill="currentColor" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M5 3.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm0 2.122a2.25 2.25 0 10-1.5 0v.878A2.25 2.25 0 005.75 8.5h1.5v2.128a2.251 2.251 0 101.5 0V8.5h1.5a2.25 2.25 0 002.25-2.25v-.878a2.25 2.25 0 10-1.5 0v.878a.75.75 0 01-.75.75h-4.5A.75.75 0 015 6.25v-.878zm3.75 7.378a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm3-8.75a.75.75 0 100-1.5.75.75 0 000 1.5z"/>
                </svg>
                Forks
              </h2>
              <button
                id="fork-filter"
                class="w-full px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 border text-left flex items-center justify-between border-violet-200 text-violet-600 hover:bg-violet-50"
                data-active="false"
              >
                <span>Show only forks</span>
                <span class="px-2 py-0.5 text-xs rounded-full bg-violet-100">
                  {stats.forks}
                </span>
              </button>
            </div>
          )}
          
          <p id="filter-status" class="text-xs text-gray-500 text-center">
            Showing {stats.active} repositories
          </p>
        </div>
      </aside>

      {/* Main Content */}
      <div class="flex-1 min-w-0">
        {/* Repository Grid */}
        <section class="mb-16">
          <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
            <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
            </svg>
            Active Repositories
          </h2>
          
          {activeRepos.length === 0 ? (
            <p class="text-gray-500 text-center py-12">No active repositories.</p>
          ) : (
            <div id="repos-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
              {activeRepos.map(repo => (
                <div class="repo-item" data-fork={repo.isFork ? "true" : "false"} data-category={repo.category}>
                  <RepoCard repo={repo} />
                </div>
              ))}
            </div>
          )}
          
          {/* No results message */}
          <p id="no-results" class="text-gray-500 text-center py-12 hidden">No repositories match the current filters.</p>
        </section>

        {/* Software GBBs Section */}
        {softwareGbbs.length > 0 && (
          <section class="mb-16 border-t border-gray-200 pt-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-2 flex items-center gap-2">
              <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
              Software GBBs
              <span class="text-sm font-normal text-gray-500 ml-2">({softwareGbbs.length} active contributors)</span>
            </h2>
            <p class="text-gray-500 mb-6">Meet the Software Global Black Belts contributing to this organization.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
              {softwareGbbs.map((member, index) => (
                <SoftwareGbbCard member={member} rank={index + 1} />
              ))}
            </div>
          </section>
        )}

        {/* Archived Repos (collapsed) */}
        {archivedRepos.length > 0 && (
          <section class="border-t border-gray-200 pt-10">
            <details class="group">
              <summary class="cursor-pointer text-lg font-semibold text-gray-500 hover:text-gray-700 flex items-center gap-2 mb-6">
                <svg class="w-5 h-5 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
                Archived Repositories ({archivedRepos.length})
              </summary>
              <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                {archivedRepos.map(repo => (
                  <RepoCard repo={repo} />
                ))}
              </div>
            </details>
          </section>
        )}
      </div>
    </div>

    {/* Footer */}
    <footer class="mt-16 pt-8 border-t border-gray-200 text-center text-sm text-gray-500">
      <p>
        Data automatically updated from
        <a href="https://github.com/DevExpGbb" class="text-blue-500 hover:underline ml-1" target="_blank" rel="noopener">
          github.com/DevExpGbb
        </a>
      </p>
      <p class="mt-2 text-xs">
        {/* Command for GitHub Actions: gh repo list DevExpGbb --json name,description,url,owner,isArchived,repositoryTopics,languages,primaryLanguage,createdAt,updatedAt,stargazerCount --limit 100 */}
        Last updated: {new Date().toLocaleDateString('en-US')}
      </p>
    </footer>
  </main>

  <script>
    // Filter state
    let activeCategory = 'all';
    let showOnlyForks = false;
    
    const forkFilter = document.getElementById('fork-filter');
    const categoryFilters = document.querySelectorAll('.category-filter');
    const repoItems = document.querySelectorAll('.repo-item');
    const noResults = document.getElementById('no-results');
    const filterStatus = document.getElementById('filter-status');
    
    // Apply all filters
    function applyFilters() {
      let visibleCount = 0;
      
      repoItems.forEach(item => {
        const itemCategory = item.getAttribute('data-category');
        const isFork = item.getAttribute('data-fork') === 'true';
        
        const matchesCategory = activeCategory === 'all' || itemCategory === activeCategory;
        const matchesFork = !showOnlyForks || isFork;
        
        if (matchesCategory && matchesFork) {
          (item as HTMLElement).style.display = '';
          visibleCount++;
        } else {
          (item as HTMLElement).style.display = 'none';
        }
      });
      
      // Show/hide no results message
      if (noResults) {
        noResults.classList.toggle('hidden', visibleCount > 0);
      }
      
      // Update filter status
      if (filterStatus) {
        filterStatus.textContent = `Showing ${visibleCount} repositor${visibleCount !== 1 ? 'ies' : 'y'}`;
      }
    }
    
    // Category filter click handlers
    categoryFilters.forEach(btn => {
      btn.addEventListener('click', () => {
        const category = btn.getAttribute('data-category')!;
        activeCategory = category;
        
        // Update button styles
        categoryFilters.forEach(b => {
          const isActive = b.getAttribute('data-category') === category;
          const badge = b.querySelector('span:last-child');
          b.setAttribute('data-active', String(isActive));
          
          if (isActive) {
            b.classList.remove('bg-white', 'text-gray-700', 'border-gray-200', 'hover:border-blue-300', 'hover:bg-blue-50');
            b.classList.add('bg-blue-600', 'text-white', 'border-blue-600', 'shadow-md');
            badge?.classList.remove('bg-gray-100');
            badge?.classList.add('bg-white/20');
          } else {
            b.classList.remove('bg-blue-600', 'text-white', 'border-blue-600', 'shadow-md');
            b.classList.add('bg-white', 'text-gray-700', 'border-gray-200', 'hover:border-blue-300', 'hover:bg-blue-50');
            badge?.classList.remove('bg-white/20');
            badge?.classList.add('bg-gray-100');
          }
        });
        
        applyFilters();
      });
    });
    
    // Fork filter click handler
    if (forkFilter) {
      forkFilter.addEventListener('click', () => {
        showOnlyForks = !showOnlyForks;
        forkFilter.setAttribute('data-active', String(showOnlyForks));
        
        // Update button style
        if (showOnlyForks) {
          forkFilter.classList.remove('border-violet-200', 'text-violet-600', 'hover:bg-violet-50');
          forkFilter.classList.add('bg-violet-500', 'text-white', 'border-violet-500');
          forkFilter.querySelector('span')!.textContent = 'Showing forks only';
        } else {
          forkFilter.classList.add('border-violet-200', 'text-violet-600', 'hover:bg-violet-50');
          forkFilter.classList.remove('bg-violet-500', 'text-white', 'border-violet-500');
          forkFilter.querySelector('span')!.textContent = 'Show only forks';
        }
        
        applyFilters();
      });
    }
  </script>
</Layout>
