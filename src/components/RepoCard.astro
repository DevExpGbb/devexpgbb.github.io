---
import type { CategorizedRepository } from '../utils/categorize';
import { formatDate, getTopLanguages } from '../utils/categorize';
import Avatar from './Avatar.astro';
import CategoryBadge from './CategoryBadge.astro';
import LanguageBadge from './LanguageBadge.astro';

interface Props {
  repo: CategorizedRepository;
}

const { repo } = Astro.props;
const topLanguages = getTopLanguages(repo, 2);
const updatedDate = formatDate(repo.updatedAt);

// Check if recently updated (within last 7 days)
const isRecentlyUpdated = (new Date().getTime() - new Date(repo.updatedAt).getTime()) < 7 * 24 * 60 * 60 * 1000;
---

<a 
  href={repo.url}
  target="_blank"
  rel="noopener noreferrer"
  class:list={[
    'repo-card group relative flex flex-col bg-white rounded-xl p-3 shadow-sm hover:shadow-lg transition-all duration-300 hover:-translate-y-1 border border-gray-100/80 overflow-hidden',
    { 'opacity-60 grayscale-[30%]': repo.isArchived }
  ]}
>
  {/* Gradient overlay on hover */}
  <div class="absolute inset-0 bg-gradient-to-br from-blue-500/5 via-transparent to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>

  {/* Badges row */}
  <div class="flex items-center gap-1.5 mb-2 relative flex-wrap">
    <CategoryBadge category={repo.categoryInfo} size="xs" />
    
    {isRecentlyUpdated && !repo.isArchived && (
      <span class="flex items-center gap-0.5 text-[10px] px-1.5 py-0.5 bg-green-50 text-green-600 rounded-full font-medium">
        <span class="w-1 h-1 bg-green-500 rounded-full animate-pulse"></span>
        Active
      </span>
    )}
    
    {repo.isArchived && (
      <span class="text-[10px] px-1.5 py-0.5 bg-gray-100 text-gray-500 rounded-full font-medium">
        Archived
      </span>
    )}
    
    {repo.isFork && (
      <span class="flex items-center gap-0.5 text-[10px] px-1.5 py-0.5 bg-violet-50 text-violet-600 rounded-full font-medium">
        <svg class="w-2.5 h-2.5" fill="currentColor" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M5 3.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm0 2.122a2.25 2.25 0 10-1.5 0v.878A2.25 2.25 0 005.75 8.5h1.5v2.128a2.251 2.251 0 101.5 0V8.5h1.5a2.25 2.25 0 002.25-2.25v-.878a2.25 2.25 0 10-1.5 0v.878a.75.75 0 01-.75.75h-4.5A.75.75 0 015 6.25v-.878zm3.75 7.378a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm3-8.75a.75.75 0 100-1.5.75.75 0 000 1.5z"/>
        </svg>
        Fork
      </span>
    )}

    {/* Stars */}
    {repo.stargazerCount > 0 && (
      <span class="ml-auto flex items-center gap-0.5 px-1.5 py-0.5 bg-amber-50 rounded-full">
        <svg class="w-3 h-3 text-amber-400" fill="currentColor" viewBox="0 0 20 20">
          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
        </svg>
        <span class="text-[10px] font-semibold text-amber-600">{repo.stargazerCount}</span>
      </span>
    )}
  </div>

  {/* Title */}
  <h3 class="font-semibold text-sm text-gray-900 group-hover:text-blue-600 transition-colors line-clamp-1 mb-1 relative">
    {repo.name}
  </h3>

  {/* Description */}
  <p class="text-xs text-gray-500 mb-2 line-clamp-2 flex-grow min-h-[2rem] leading-relaxed relative">
    {repo.description || 'No description provided'}
  </p>

  {/* Languages */}
  {topLanguages.length > 0 && (
    <div class="flex flex-wrap gap-1 mb-2 relative">
      {topLanguages.map(lang => (
        <LanguageBadge name={lang} />
      ))}
    </div>
  )}

  {/* Footer: Contributor + Updated */}
  <div class="flex items-center justify-between pt-2 border-t border-gray-100/80 relative">
    <div class="flex items-center gap-1.5">
      {repo.topContributor ? (
        <Avatar login={repo.topContributor.login} size="xs" showName={true} />
      ) : (
        <Avatar login={repo.owner.login} size="xs" showName={true} />
      )}
    </div>
    <div class="flex items-center gap-1 text-[10px] text-gray-400">
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <span>{updatedDate}</span>
    </div>
  </div>
</a>

<style>
  .repo-card {
    backdrop-filter: blur(8px);
  }
</style>
