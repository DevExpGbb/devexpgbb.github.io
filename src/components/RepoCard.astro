---
import type { CategorizedRepository } from '../utils/categorize';
import { formatDate, getTopLanguages } from '../utils/categorize';
import Avatar from './Avatar.astro';
import CategoryBadge from './CategoryBadge.astro';
import LanguageBadge from './LanguageBadge.astro';

interface Props {
  repo: CategorizedRepository;
}

const { repo } = Astro.props;
const topLanguages = getTopLanguages(repo, 3);
const updatedDate = formatDate(repo.updatedAt);

// Check if recently updated (within last 7 days)
const isRecentlyUpdated = (new Date().getTime() - new Date(repo.updatedAt).getTime()) < 7 * 24 * 60 * 60 * 1000;
---

<a 
  href={repo.url}
  target="_blank"
  rel="noopener noreferrer"
  class:list={[
    'repo-card group relative flex flex-col bg-white rounded-2xl p-5 shadow-sm hover:shadow-2xl transition-all duration-300 hover:-translate-y-2 border border-gray-100/80 overflow-hidden',
    { 'opacity-60 grayscale-[30%]': repo.isArchived }
  ]}
>
  {/* Gradient overlay on hover */}
  <div class="absolute inset-0 bg-gradient-to-br from-blue-500/5 via-transparent to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
  
  {/* Shine effect */}
  <div class="absolute inset-0 -translate-x-full group-hover:translate-x-full transition-transform duration-700 bg-gradient-to-r from-transparent via-white/20 to-transparent pointer-events-none"></div>

  {/* Badges row */}
  <div class="flex items-center gap-2 mb-3 relative">
    <CategoryBadge category={repo.categoryInfo} />
    
    {isRecentlyUpdated && !repo.isArchived && (
      <span class="flex items-center gap-1 text-xs px-2 py-0.5 bg-green-50 text-green-600 rounded-full font-medium">
        <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
        Active
      </span>
    )}
    
    {repo.isArchived && (
      <span class="text-xs px-2 py-0.5 bg-gray-100 text-gray-500 rounded-full font-medium">
        Archived
      </span>
    )}
  </div>

  {/* Stars - moved to prominent position */}
  {repo.stargazerCount > 0 && (
    <div class="absolute top-4 right-4 flex items-center gap-1 px-2 py-1 bg-amber-50 rounded-full">
      <svg class="w-4 h-4 text-amber-400" fill="currentColor" viewBox="0 0 20 20">
        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
      </svg>
      <span class="text-sm font-semibold text-amber-600">{repo.stargazerCount}</span>
    </div>
  )}

  {/* Title with icon */}
  <div class="flex items-start gap-2 mb-2 relative">
    <svg class="w-5 h-5 text-gray-400 mt-0.5 flex-shrink-0 group-hover:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
    </svg>
    <h3 class="font-bold text-lg text-gray-900 group-hover:text-blue-600 transition-colors line-clamp-1 pr-12">
      {repo.name}
    </h3>
  </div>

  {/* Description */}
  <p class="text-sm text-gray-500 mb-4 line-clamp-2 flex-grow min-h-[2.5rem] leading-relaxed relative">
    {repo.description || 'No description provided'}
  </p>

  {/* Languages */}
  {topLanguages.length > 0 && (
    <div class="flex flex-wrap gap-2 mb-4 relative">
      {topLanguages.map(lang => (
        <LanguageBadge name={lang} />
      ))}
    </div>
  )}

  {/* Footer: Contributor + Updated */}
  <div class="flex items-center justify-between pt-3 border-t border-gray-100/80 relative">
    <div class="flex items-center gap-2">
      {repo.topContributor ? (
        <Avatar login={repo.topContributor.login} size="sm" showName={true} />
      ) : (
        <Avatar login={repo.owner.login} size="sm" showName={true} />
      )}
    </div>
    <div class="flex items-center gap-1.5 text-xs text-gray-400">
      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <span>{updatedDate}</span>
    </div>
  </div>

  {/* Hover arrow */}
  <div class="absolute bottom-5 right-5 opacity-0 group-hover:opacity-100 group-hover:translate-x-0 -translate-x-2 transition-all duration-300">
    <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
    </svg>
  </div>
</a>

<style>
  .repo-card {
    backdrop-filter: blur(8px);
  }
</style>
