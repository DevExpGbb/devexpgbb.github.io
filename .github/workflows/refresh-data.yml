name: ğŸ”„ Refresh Repository Data

on:
  schedule:
    # Runs at 8:00 AM and 6:00 PM UTC
    - cron: "0 8,18 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  refresh:
    name: ğŸ“Š Fetch Repository Data
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Fetch repositories from DevExpGbb
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¦ Fetching public repository list..."

          # Fetch only PUBLIC repos with basic info
          if ! gh repo list DevExpGbb \
            --json name,description,url,owner,isArchived,repositoryTopics,languages,primaryLanguage,createdAt,updatedAt,stargazerCount \
            --visibility public \
            --limit 200 \
            > /tmp/repos_basic.json; then
            echo "âŒ Failed to fetch repository list"
            exit 1
          fi

          # Validate that we got valid JSON
          if ! jq empty /tmp/repos_basic.json 2>/dev/null; then
            echo "âŒ Invalid JSON received from gh repo list"
            cat /tmp/repos_basic.json
            exit 1
          fi

          echo "ğŸ‘¥ Fetching top contributors for each repository..."

          # Process each repo to add top contributor
          jq -c '.[]' /tmp/repos_basic.json | while read -r repo; do
            repo_name=$(echo "$repo" | jq -r '.name')
            echo "  Processing: $repo_name"
            
            # Fetch top contributor (first one from contributors list)
            # If the API call fails or returns empty, use null
            if top_contributor_raw=$(gh api "repos/DevExpGbb/${repo_name}/contributors" 2>/dev/null) && \
               [ -n "$top_contributor_raw" ] && \
               top_contributor=$(echo "$top_contributor_raw" | jq -e 'if length == 0 then null else .[0] | {login: .login, avatarUrl: .avatar_url} end' 2>/dev/null); then
              # Successfully got contributor data
              :
            else
              # API failed, returned empty, or invalid data - use null
              top_contributor=null
            fi
            
            # Add topContributor to repo object
            echo "$repo" | jq --argjson tc "$top_contributor" '. + {topContributor: $tc}'
          done | jq -s '.' > src/data/repositories.json

          echo "âœ… Generated repositories.json with $(jq length src/data/repositories.json) repositories"

      - name: ğŸ“ Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet src/data/repositories.json; then
            echo "ğŸ“­ No changes detected"
          else
            git add src/data/repositories.json
            git commit -m "ğŸ”„ Refresh repository data [skip ci]"
            git push
            echo "ğŸ“¬ Changes committed and pushed"
          fi
