name: ðŸ”„ Refresh Repository Data

on:
  schedule:
    # Runs at 8:00 AM and 6:00 PM UTC
    - cron: "0 8,18 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  refresh:
    name: ðŸ“Š Fetch Repository Data
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Fetch repositories from DevExpGbb
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          echo "ðŸ“¦ Fetching public repository list..."

          # Fetch only PUBLIC repos with basic info
          gh repo list DevExpGbb \
            --json name,description,url,owner,isArchived,isFork,repositoryTopics,languages,primaryLanguage,createdAt,updatedAt,stargazerCount \
            --visibility public \
            --limit 200 \
            > /tmp/repos_basic.json

          repo_count=$(jq length /tmp/repos_basic.json)
          echo "ðŸ“‹ Found $repo_count public repositories"

          echo "ðŸ‘¥ Fetching top contributors for each repository..."

          # Create output file
          echo "[" > /tmp/repos_with_contributors.json
          first=true

          # Process each repo
          for row in $(jq -r '.[] | @base64' /tmp/repos_basic.json); do
            _jq() {
              echo "$row" | base64 --decode | jq -r "$1"
            }
            
            repo_name=$(_jq '.name')
            echo "  Processing: $repo_name"
            
            # Get the full repo object
            repo_json=$(echo "$row" | base64 --decode)
            
            # Fetch top contributor
            top_contributor="null"
            if contributor_data=$(gh api "repos/DevExpGbb/${repo_name}/contributors" --jq '.[0] | {login: .login, avatarUrl: .avatar_url}' 2>/dev/null); then
              if [ -n "$contributor_data" ] && [ "$contributor_data" != "null" ]; then
                top_contributor="$contributor_data"
              fi
            fi
            
            # Add comma separator for all but first
            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> /tmp/repos_with_contributors.json
            fi
            
            # Add repo with contributor
            echo "$repo_json" | jq --argjson tc "$top_contributor" '. + {topContributor: $tc}' >> /tmp/repos_with_contributors.json
          done

          echo "]" >> /tmp/repos_with_contributors.json

          # Format the final JSON
          jq '.' /tmp/repos_with_contributors.json > src/data/repositories.json

          echo "âœ… Generated repositories.json with $(jq length src/data/repositories.json) repositories"

      - name: ðŸ“ Commit and push if changed
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet src/data/repositories.json; then
            echo "ðŸ“­ No changes detected"
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            git add src/data/repositories.json
            git commit -m "ðŸ”„ Refresh repository data [skip ci]"
            git pull --rebase origin main
            git push
            echo "ðŸ“¬ Changes committed and pushed"
            echo "changes=true" >> $GITHUB_OUTPUT
          fi
